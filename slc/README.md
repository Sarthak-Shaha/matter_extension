# SLC Integration for Matter

This directory contains a prototype of integrating Matter with the SLC project generator, including tighter
integration with the Gecko SDK.

This integration avoids all use of pre-generated content in the matter_support repo, and instead uses SLC-CLI to genererate the project specific content.

The following modifications have been made to make this possible:

* LEDWidget.cpp: `extern "C"` missing in generated SDK API header, added here as a workaround
* OTAConfig.cpp: Changed include path to match SLC metadata. Suppressed sl_app_properties structure if using the centralized version from the SDK.
* matter_config.cpp: Removed runtime setting of mbedTLS malloc/free, as SDK configures this in mbedTLS config header at compile time. Also suppressed OTA setup if OTA isn't enabled (technically unrelated to SLC).
* BLEManagerImpl.cpp: Use RTOS integration from Gecko SDK instead of freertos_bluetooth.c
* freertos_bluetooth.c: Removed, as it is superflous and duplicates SDK functionality.
* CHIPDevicePlatformConfig.h: Removed hard-coding of CHIPoBLE feature. Should be configured by GN or SLC.
* OTAImageProcessorImpl.cpp: Changed include paths to match SLC metadata.
* gatt.xml: Renamed to gatt.btconf to be compatible with SLC

Additionally, the slc/inc directory contains config headers matching those generated by GN. They are hooked up to SLC component presence/absence, or hooked into a new SLC-enabled config header `sl_matter_config.h`. 
The ASN1 header is generated by `./src/lib/asn1/gen_asn1oid.py --output_file=slc/inc/asn1/ASN1OID.h`.
The zap-generated directory contains a single file `af-gen-event.h`. This file is empty, and has no function, but it needs to exist on disk to make certain source files compile.
Other headers have been manually copied and modified based on the content of their respective GN files.

Components: 
* slc/component/autogen: auto-generated components from GN metadata (compile_commands.json). Generated from the root of the repo by `./slc/script/gen_components.py out/lock-app/BRD4161A/compile_commands.json`.
* slc/component: Wrappers to improve SLC DX.

Sample Apps:
* lock-app: Copy of the standard lock app. 

## Gecko SDK

The SDK isn't entirely capable of supporting Matter as-is. There are a couple of blockers that need patching:

* Suppress OpenThread RTOS integration, since Matter does this differently
* Allow mbedTLS to use the CHIP platform allocator instead of sl_malloc

There are two options to handle this:

* Clone the relevant components into the Matter extension
* Patch the SDK

For this prototype, the latter option has been chosen due to being the path of least resistance (with the minimal amount of SDK content duplicated into the Matter extension). If this is to be released, we must change to the former option, or get the changes upstreamed into the main SDK.

See `slc/script/gsdk_matter.patch` for the diff. The diff is automatically applied by the build script.

## Building Using SLC

To build using SLC:

* ensure that `git` and `slc` are on your path
* ensure that the environment variable `ARM_GCC_DIR` points to the parent directory of `bin/arm-none-eabi-*`

```
cd slc/lock-app
./build.sh brd4161a
```

This will automatically set up all prerequisites, generate and build the project:
* register Matter extension with SDK
* patch ZAP to generate for Matter instead of Zigbee
* patch the SDK to support Matter
* trust the SDK and extension
* generate the project
* patch the Makefile to build for C++17 with GNU extensions
* build the project
